# ディスクシステムの仕組み
Editing now.

* 正確性の保証はないことに注意

## 基本情報
* ディスク容量(片面) = 8[KB] = 8192[Byte] = 65536[bit] 
* Clock = 96.4[kHz] (T = 10.37=10.373443983402...[us])
* Modulation = MFM  // MFM変調
* Sending data to order LSB to MSB
* I/O Level = 5V

[ここの情報を整理しようと思う](http://kitahei88.blog.fc2.com/blog-category-4-2.html)
## 書き込みプロテクト
### 見分け方
- 付属のRAMアダプターがツルツルがプロテクトなし、ザラザラはプロテクト有り
- ドライブ基板の番号が01~03はプロテクトなし、04と05はプロテクト有り

### 参考文献
[FDS Stickでディスクシステムのゲームを書き込んでみる](https://ameblo.jp/koudaken7777/entry-12648274550.html)

## Signal(信号)
### Ram Adapter <-> Disk Drive
#### Connector

```
 ドライブ側のメス端子を正面に見て

 /-----------------\
/  2  4  6  8 10 12 \
|                   |
|  1  3  5  7  9 11 |
+-------------------+

```

|No|色|名前|RAM-Drive|説明|
|:-:|:-:|:-:|:-:|:-|
|1|緑|/Write Gate|->|0=Writeモード, 1=Readモード|
|2||Vcc Out|<-?|ドライブからの電源出力？|
|3|水|Vcc 5V|->|ドライブへの電源(RAMへは未接続)|
|4|青|/Scan Media|<-|0=メディアをスキャン中|
|5|茶|GND|-||
|6|橙|Write Data|->|ディスクへの書込みデータ|
|7|桃|Battery Sense|<-|0=バッテリーエラー, 1=バッテリOK|
|8|灰|/Writable|<-|0=メディアが書き込み不可, 1=書き込み可能<br>メディアの爪を判断している|
|9|黄|Read Data|<-|ディスクからの読込みデータ|
|10|黒|/Media Set|<-|0=ドライブにディスク有, 1=なし|
|11|白|/Ready|<-|0=ドライブのヘッダがデータ領域にある,1=それ以外<br>つまりヘッダが開始位置に来たら"0"<br>ヘッダが最後までいくか/Stop Motor=0になったら"1"に戻る|
|12|紫|/Stop Motor|->|0=モーターを止める, 1=なにもしない|

'/' は反転

## ステータス

|項目|電<br>源<br>O<br>N|デ<br>ィ<br>ス<br>ク<br>挿<br>入|M<br>o<br>t<br>r<br>o<br>r<br> <br>O<br>n|ヘ<br>ッ<br>ダ<br>初<br>期<br>化<br>*|外<br>周<br>到<br>達<br>*|読<br>み<br>込<br>み<br>*|内<br>周<br>到<br>達<br>*||M<br>o<br>t<br>o<br>r<br> <br>O<br>f<br>f||R<br>e<br>s<br>e<br>t|
|:-|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|<h4>ドライブステータス</h4>||||||||||||
|/Media Set             |H|L|-|-|-|-|-||L||L|
|/Writable              |x|L(*1)|-|-|-|-|-||L||L|
|/Ready                 |H||||L|L||||||
|/Media Scan            |H||L|-|-|-|-|||||
|<h4>データ</h4>||||||||||||
|Read Data              |x|-|-|-|D|D|L||L||L|
|<h4>イベント</h4>||||||||||||
|/Write Gate            |H/L|-|
|/Stop Motor            |H|-|-|-|||||||L|

- 未記入は'H'レベル
- 'x'は、不明
- 'D'は、データ信号
- '-'は、直前と同じ
- 'H/L'は、Readモード/Writeモード時の値
- '*' の工程は、Motorがオン(/Motor=L)の間繰り返す
- *1 メディアの爪が折れていないと想定

## MFM変調
* クロックビット、データビットの順番で送信する
* クロックビットは通常０
* ただし、前のデータビットと今のデータビットがゼロの場合、クロックビットは１

Example(例)

```
0xa5 = 1010 0101 b
Data bit  = 1 0 1 0 0 1 0 1
Clock bit =X 0 0 0 1 0 0 0
Send data =X100010010010001
(X は未確定)
```

### 例2
|データ|2進数|信号(Clock/Data)|
|:-:|:-:|:-:|
|0|0000 0000|X0 10 10 10 , 10 10 10 10|
|1|1000 0000|01 00 10 10 , 10 10 10 10|
|2|0100 0000|X0 01 00 10 , 10 10 10 10|
|3|1100 0000|01 01 00 10 , 10 10 10 10|
|4|0010 0000|X0 10 01 00 , 10 10 10 10|
|5|1010 0000|01 00 01 00 , 10 10 10 10|
|6|0110 0000|X0 01 01 00 , 10 10 10 10|
|7|1110 0000|01 01 01 00 , 10 10 10 10|
|8|0001 0000|X0 10 10 01 , 00 10 10 10|
|9|1001 0000|01 00 10 01 , 00 10 10 10|
|10|0101 0000|X0 01 00 01 , 00 10 10 10|
|11|1101 0000|01 01 00 01 , 00 10 10 10|
|12|0011 0000|X0 10 01 01 , 00 10 10 10|
|13|1011 0000|01 00 01 01 , 00 10 10 10|
|14|0111 0000|X0 01 01 01 , 00 10 10 10|
|15|1111 0000|01 01 01 01 , 00 10 10 10|

* データの先頭はLSB(つまり $80は '0000 0001'bになる)
* 'X'は、その前のデータビットの値により変化する

### クロックアップ周期(Term of clock-up)

* 1T = 1/96.4kHz = 10.373443983402... = 10.37[us]
* 1.5T = 1/96.4kHz x 1.5 = 15.560165975103... = 15.56[us]
* 2T = 1/96.4kHz x 2 = 20.746887966804... = 20.75[us]

### 検出周期と追加ビット
|最後尾ビット|検出周期|追加ビット|
|:-|:-:|:-:|
|0|1T|0|
|0|1.5T|1|
|1|1T|1|
|1|1.5T|00|
|1|2T|01|

## References(参考文献)
[ディスクシステムローダー（セーバー）の準備:レトロゲーム漫遊記](http://kitahei88.blog.fc2.com/blog-entry-102.html)
[ディスクシステムローダー（セーバー）の準備　その2:レトロゲーム漫遊記](http://kitahei88.blog.fc2.com/blog-entry-103.html#more)
[jfdsloadr.txt:エミュレートステーション](http://www.emusta.net/jfdsloadr.txt)
